#include "nrf24l01.h"


void nrf24l01_init (unsigned char m)
{
	//===Settings SPI===//
	init_spi_8 ();
	
	//===Settings pins===//
	RCC->AHBENR |= RCC_AHBENR_GPIOAEN;
	
	//CE
	PORT->MODER &= ~GPIO_MODER_MODER2;
	PORT->OTYPER &= ~GPIO_OTYPER_OT_2;
	
	//IRQ
	PORT->MODER &= ~GPIO_MODER_MODER3;
	EXTI->IMR |= 1 << IRQ;
	EXTI->FTSR |= 1 << IRQ;
	
	//===Setup 
	
  //SETBIT(nrf24l01_IRQ_PORT,nrf24l01_IRQ_PIN);
	
  clear_cs();//???? ?? ?????
  CE_CLEAR;//???? ?? ?????
  delay_ms(15);//????? ?? ????????????? (???????? ????? ?????? ???????)
  
  /* 
   ?????????? ?? ???? ????????? ??????? ? EN_AA
   ? ?????????????? ????????? ???????? ???? ????????? ????? ?????? ???? ???
   
     1) ????????? ??????????????? ???????  ???????? ?? ?????????    EN_AA
     2) ????????? ??????? ??????                                    EN_RXADDR
	 3) ????? ????? ??????                                          SETUP_AW
	 4) ????????? ???????????? ??????                               SETUP_RETER
	 5) ????????? ???????                                           RF_CH
     6) ?????????? ???????? ???????? + ???????? ?????????           RF_SETUP
	 7) ??????? ??????? (?? ?????????????)                          STATUS
	 8) ??????? ?????????? ????????? ??????? ??????                 OBSERVE_TX
	 9) ??????? ???????????? ??? ??????? ???????                    CD
	 10) ???????? ???????? ??????? ?? ????? ??????                  RX_ADDR_P(0-5)
     11) ??????? ??? ???????? ?????? ?? ????????                    TX_ADDR
     12) ???????? ????????? ???????? ???????? ??? ??????? ??????    RX_PW_P(0-5)
     13) ??????? ??????? ??????? ????????? ? ???????????            FIFO_STATUS  
  */
  //12-?? ????? ????????? ? ?????????
  nrf24l01_sc_bit(RX_PW_P0,0,1);// ????????????? 8??? ???????? ????????
  
   //?????????? ?????????? (???/?????????) ?? 3-? ?? ????????? ???????? ???!
   nrf24l01_sc_bit(CONFIG,MASK_MAX_RT,m&(1<<0));
   nrf24l01_sc_bit(CONFIG,MASK_TX_DS,m&(1<<1));
   nrf24l01_sc_bit(CONFIG,MASK_RX_DR,m&(1<<2));
  
  // nrf24l01_sc_bit(CONFIG,PRIM_RX,1);//????????????? ????? ????????
   nrf24l01_sc_bit(CONFIG,PWR_UP,1);//????????????? ??? ??? ? ??????? (???????? ??????)
   delay_ms(2);//???????? ?? ?????????
   

   
   //?????? ?? ? ?????? ????????-1
}
	


uint8_t nrf24l01_wr_register (uint8_t r_n_reg,uint8_t mask1, uint8_t mask2 )
{
	uint8_t r_regist=0;
	clear_cs();
  
	//command for read register
  spi1_tx_8(mask1+r_n_reg);
	
	//read register
  r_regist = spi1_exchange_8(mask2);
  set_cs();
  
  return r_regist; //?????????? ???????? ????????		
}


//??????? ?????? ??? ??????
unsigned char nrf24l01_command (unsigned char M_ask)
{   
	unsigned char ST=0;//?????????? ??? ???????? STATUS
  clear_cs();//???????? ????? ??? ?????? ???????? 
	ST=spi1_exchange_8(M_ask);//?????? ??????? STATUS
	set_cs();//???????? ?????
	return ST; //?????????? ???????? STATUS	
}




/* ??????? ????????? ?????? ???? ??? ? ????????
-????????? ??????? ? ??????? ????? ???????? ???
-??? ??????? ????? ????????
-???????? ?? ??????? ????? ????????
*/
void nrf24l01_sc_bit (unsigned char reg_ister,unsigned char register_bit,char W)
{
unsigned char buf;//?????????? ?????????? ????????
buf=nrf24l01_readregister(reg_ister);//?????? ???????? ????????
if(W)//???? ????? ?????????? ??? ? "1"
buf=buf|(1<<register_bit);//?????? ??? ? ??????????? ????????
else
buf=buf&(~(1<<register_bit));//?????? ??? ? ??????????? ????????
nrf24l01_writeregister(reg_ister,buf);//????? ? ??????? ????? ????????	
}


void nrf24l01_RX_TX_mode (char z)
{
 //????????? ? ????? ????????-1 ?? ?????? ????????? 
 CE_CLEAR;
 //????????????? ????? ????????	????? PRIM_RX ???
 nrf24l01_sc_bit(CONFIG,PRIM_RX,z);
 //????????? ? ???? ?? ???????
 CE_SET;
 delay_us(15);
 if(!z)  CE_CLEAR;
 delay_us(140);//???????? ?? ??????? (10+140)
}

//?????????? ?????
void nrf24l01_write_data (unsigned char data) 
{
		clear_cs();//???????? ????? ??? ?????? ????????
    spi1_tx_8(W_TX_PAYLOAD);//??????? ??????
    spi1_tx_8(data);
    set_cs();//???????? ?????
    //?????????? ?????????? ???? ??? ?????????
}


//?????????? ?????? ? ?????? ???????????
void nrf24l01_Sent_data_Ret (unsigned char data) 
{
   nrf24l01_write_data(data);//?????????? ????? ? ????? ???????????
   nrf24l01_RX_TX_mode(PTX);//???? ??????? ?? ???????? ???? ????? ?? ????????
   nrf24l01_RX_TX_mode(PRX);//????? ???????? ???????????? ? ????? ?????????
}

//?????? ??????
unsigned char nrf24l01_read_data (void) 
{
	unsigned char i;
	  clear_cs();//???????? ????? ??? ?????? ????????
    spi1_tx_8(R_RX_PAYLOAD);//??????? ??????
    i=spi1_exchange_8(NOP);
    set_cs();//???????? ?????
	return i;
}



